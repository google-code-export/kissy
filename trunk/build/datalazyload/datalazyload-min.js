/*
Copyright (c) 2009, Kissy UI Library. All rights reserved.
MIT Licensed.
http://kissy.googlecode.com/

Date: 2009-12-22 23:10:37
Revision: 333
*/
KISSY.add("datalazyload",function(f){var b=YAHOO.util,g=b.Dom,m=b.Event,i=YAHOO.lang,j=window,l=document,a="data-lazyload-src",k="ks-datalazyload",d={AUTO:"auto",MANUAL:"manual"},h="default",e={mod:d.MANUAL,diff:h,placeholder:"http://a.tbcdn.cn/kissy/1.0.2/build/datalazyload/dot.gif"};function c(o,n){if(!(this instanceof arguments.callee)){return new arguments.callee(o,n)}if(typeof n==="undefined"){n=o;o=[l]}if(!i.isArray(o)){o=[g.get(o)||l]}this.containers=o;this.config=f.merge(e,n||{});this.callbacks={els:[],fns:[]};this._init()}f.mix(c.prototype,{_init:function(){this.threshold=this._getThreshold();this._filterItems();if(this._getItemsLength()){this._initLoadEvent()}},_initLoadEvent:function(){var q,p=this;m.on(j,"scroll",n);m.on(j,"resize",function(){p.threshold=p._getThreshold();n()});if(p._getItemsLength()){m.onDOMReady(function(){o()})}function n(){if(q){return}q=setTimeout(function(){o();q=null},100)}function o(){p._loadItems();if(p._getItemsLength()===0){m.removeListener(j,"scroll",n);m.removeListener(j,"resize",n)}}},_filterItems:function(){var p=this.containers,v=this.threshold,z=this.config.placeholder,q=this.config.mod===d.MANUAL,o,x,t,u,s,w,r,B,A=[],y=[];for(o=0,x=p.length;o<x;++o){t=p[o].getElementsByTagName("img");for(s=0,w=t.length;s<w;++s){r=t[s];B=r.getAttribute(a);if(q){if(B){r.src=z;A.push(r)}}else{if(g.getY(r)>v&&!B){r.setAttribute(a,r.src);r.src=z;A.push(r)}}}u=p[o].getElementsByTagName("textarea");for(s=0,w=u.length;s<w;++s){if(g.hasClass(u[s],k)){y.push(u[s])}}}this.images=A;this.areaes=y},_loadItems:function(){this._loadImgs();this._loadAreaes();this._fireCallbacks()},_loadImgs:function(){var t=this.images,q=g.getDocumentScrollTop(),n=this.threshold+q,p,o,s,r=[];for(p=0;o=t[p++];){if(g.getY(o)<=n){s=o.getAttribute(a);if(s&&o.src!=s){o.src=s;o.removeAttribute(a)}}else{r.push(o)}}this.images=r},_loadAreaes:function(){var r=this.areaes,s=g.getDocumentScrollTop(),n=this.threshold+s,o,q,p,t=[];for(o=0;q=r[o++];){p=q.parentNode;if(g.getY(p)<=n){p.innerHTML=q.value}else{t.push(q)}}this.areaes=t},_fireCallbacks:function(){var t=this.callbacks,q=t.els,w=t.fns,n=g.getDocumentScrollTop(),s=this.threshold+n,r,o,v,u=[],p=[];for(r=0;(o=q[r])&&(v=w[r++]);){if(g.getY(o)<=s){v.call(o)}else{u.push(o);p.push(v)}}t.els=u;t.fns=p},addCallback:function(o,n){o=g.get(o);if(o&&typeof n==="function"){this.callbacks.els.push(o);this.callbacks.fns.push(n)}},_getThreshold:function(){var o=this.config.diff,n=g.getViewportHeight();if(o===h){return 2*n}else{return n+o}},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length}});f.DataLazyload=c});
