/*
Copyright (c) 2010, Kissy UI Library. All rights reserved.
MIT Licensed.
http://kissy.googlecode.com/

Date: 2009-12-31 11:24:06
Revision: 391
*/
KISSY.add("datalazyload",function(g){var a=YAHOO.util,h=a.Dom,o=a.Event,j=YAHOO.lang,k=window,n=document,l="data-lazyload-src",p="ks-datalazyload",f=l+"-custom",b=p+"-custom",d={AUTO:"auto",MANUAL:"manual"},i="default",m="none",e={mod:d.MANUAL,diff:i,placeholder:"http://a.tbcdn.cn/kissy/1.0.2/build/datalazyload/dot.gif"};function c(s,r){var q=this;if(!(q instanceof arguments.callee)){return new arguments.callee(s,r)}if(typeof r==="undefined"){r=s;s=[n]}if(!j.isArray(s)){s=[h.get(s)||n]}q.containers=s;q.config=g.merge(e,r||{});q.callbacks={els:[],fns:[]};q._init()}g.mix(c.prototype,{_init:function(){var q=this;q.threshold=q._getThreshold();q._filterItems();if(q._getItemsLength()){q._initLoadEvent()}},_initLoadEvent:function(){var t,s=this;o.on(k,"scroll",q);o.on(k,"resize",function(){s.threshold=s._getThreshold();q()});if(s._getItemsLength()){o.onDOMReady(function(){r()})}function q(){if(t){return}t=setTimeout(function(){r();t=null},100)}function r(){s._loadItems();if(s._getItemsLength()===0){o.removeListener(k,"scroll",q);o.removeListener(k,"resize",q)}}},_filterItems:function(){var D=this,s=D.containers,y=D.threshold,C=D.config.placeholder,t=D.config.mod===d.MANUAL,r,A,x,w,v,z,u,q,F,E=[],B=[];for(r=0,A=s.length;r<A;++r){x=s[r].getElementsByTagName("img");for(v=0,z=x.length;v<z;++v){u=x[v];F=u.getAttribute(l);if(t){if(F){u.src=C;E.push(u)}}else{if(h.getY(u)>y&&!F){u.setAttribute(l,u.src);u.src=C;E.push(u)}}}w=s[r].getElementsByTagName("textarea");for(v=0,z=w.length;v<z;++v){q=w[v];if(h.hasClass(q,p)){B.push(q)}}}D.images=E;D.areaes=B},_loadItems:function(){var q=this;q._loadImgs();q._loadAreaes();q._fireCallbacks()},_loadImgs:function(){var s=this,x=s.images,u=h.getDocumentScrollTop(),q=s.threshold+u,t,r,w,v=[];for(t=0;r=x[t++];){if(h.getY(r)<=q){s._loadImgSrc(r)}else{v.push(r)}}s.images=v},_loadImgSrc:function(r,q){q=q||l;var s=r.getAttribute(q);if(s&&r.src!=s){r.src=s;r.removeAttribute(q)}},_loadAreaes:function(){var r=this,v=r.areaes,w=h.getDocumentScrollTop(),q=r.threshold+w,s,u,t,x=[];for(s=0;u=v[s++];){t=u.parentNode;if(h.getY(t)<=q){r._loadDataFromArea(t,u)}else{x.push(u)}}r.areaes=x},_loadDataFromArea:function(q,s){var r=document.createElement("DIV");r.innerHTML=s.value;s.style.display=m;s.className="";q.appendChild(r)},_fireCallbacks:function(){var A=this,w=A.callbacks,t=w.els,z=w.fns,q=h.getDocumentScrollTop(),v=A.threshold+q,u,r,y,x=[],s=[];for(u=0;(r=t[u])&&(y=z[u++]);){if(h.getY(r)<=v){y.call(r)}else{x.push(r);s.push(y)}}w.els=x;w.fns=s},addCallback:function(r,q){r=h.get(r);if(r&&typeof q==="function"){this.callbacks.els.push(r);this.callbacks.fns.push(q)}},_getThreshold:function(){var r=this.config.diff,q=h.getViewportHeight();if(r===i){return 2*q}else{return q+r}},_getItemsLength:function(){var q=this;return q.images.length+q.areaes.length+q.callbacks.els.length},loadCustomLazyData:function(u,s,q){var r=this,t,v;if(!j.isArray(u)){u=[h.get(u)]}g.each(u,function(x){switch(s){case"textarea-data":t=x.getElementsByTagName("textarea")[0];if(t&&h.hasClass(t,q||b)){r._loadDataFromArea(x,t)}break;default:if(x.nodeName==="IMG"){v=[x]}else{v=x.getElementsByTagName("img")}for(var y=0,w=v.length;y<w;y++){r._loadImgSrc(v[y],q||f)}}})}});g.mix(c,c.prototype,true,["loadCustomLazyData","_loadImgSrc","_loadDataFromArea"]);g.DataLazyload=c});
