/*
Copyright 2010, KISSY UI Library v1.0.5
MIT Licensed
build: 521 Apr 5 12:27
*/
KISSY.add("datalazyload",function(m,w){function l(a,b){if(!(this instanceof l))return new l(a,b);if(b===w){b=a;a=[r]}s.isArray(a)||(a=[h.get(a)||r]);this.containers=a;this.config=m.merge(x,b||{});this.callbacks={els:[],fns:[]};this._init()}var t=YAHOO.util,h=t.Dom,n=t.Event,s=YAHOO.lang,o=window,r=document,u={AUTO:"auto",MANUAL:"manual"},x={mod:u.MANUAL,diff:"default",placeholder:"http://a.tbcdn.cn/kissy/1.0.4/build/datalazyload/dot.gif"};m.mix(l.prototype,{_init:function(){this.threshold=this._getThreshold();
this._filterItems();this._getItemsLength()&&this._initLoadEvent()},_initLoadEvent:function(){function a(){c||(c=setTimeout(function(){b();c=null},100))}function b(){d._loadItems();if(d._getItemsLength()===0){n.removeListener(o,"scroll",a);n.removeListener(o,"resize",a)}}var c,d=this;n.on(o,"scroll",a);n.on(o,"resize",function(){d.threshold=d._getThreshold();a()});d._getItemsLength()&&n.onDOMReady(function(){b()})},_filterItems:function(){var a=this.containers,b=this.threshold,c=this.config.placeholder,
d=this.config.mod===u.MANUAL,e,g,f,i,k,j,p,q=[],v=[];e=0;for(g=a.length;e<g;++e){f=a[e].getElementsByTagName("img");i=0;for(k=f.length;i<k;++i){j=f[i];p=j.getAttribute("data-lazyload-src");if(d){if(p){j.src=c;q.push(j)}}else if(h.getY(j)>b&&!p){j.setAttribute("data-lazyload-src",j.src);j.src=c;q.push(j)}}f=a[e].getElementsByTagName("textarea");i=0;for(k=f.length;i<k;++i){j=f[i];h.hasClass(j,"ks-datalazyload")&&v.push(j)}}this.images=q;this.areaes=v},_loadItems:function(){this._loadImgs();this._loadAreaes();
this._fireCallbacks()},_loadImgs:function(){var a=this.images,b=this.threshold+h.getDocumentScrollTop(),c,d,e=[];for(c=0;d=a[c++];)h.getY(d)<=b?this._loadImgSrc(d):e.push(d);this.images=e},_loadImgSrc:function(a,b){b=b||"data-lazyload-src";var c=a.getAttribute(b);if(c&&a.src!=c){a.src=c;a.removeAttribute(b)}},_loadAreaes:function(){var a=this.areaes,b=this.threshold+h.getDocumentScrollTop(),c,d,e,g=[];for(c=0;d=a[c++];){e=d.parentNode;h.getY(e)<=b?this._loadDataFromArea(e,d):g.push(d)}this.areaes=
g},_loadDataFromArea:function(a,b){var c=document.createElement("DIV");c.innerHTML=b.value;b.style.display="none";b.className="";a.appendChild(c)},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,d=this.threshold+h.getDocumentScrollTop(),e,g,f,i=[],k=[];for(e=0;(g=b[e])&&(f=c[e++]);)if(h.getY(g)<=d)f.call(g);else{i.push(g);k.push(f)}a.els=i;a.fns=k},addCallback:function(a,b){if((a=h.get(a))&&typeof b==="function"){this.callbacks.els.push(a);this.callbacks.fns.push(b)}},_getThreshold:function(){var a=
this.config.diff,b=h.getViewportHeight();return a==="default"?2*b:b+a},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var d=this,e,g;s.isArray(a)||(a=[h.get(a)]);m.each(a,function(f){switch(b){case "textarea-data":if((e=f.getElementsByTagName("textarea")[0])&&h.hasClass(e,c||"ks-datalazyload-custom"))d._loadDataFromArea(f,e);break;default:g=f.nodeName==="IMG"?[f]:f.getElementsByTagName("img");f=0;for(var i=g.length;f<
i;f++)d._loadImgSrc(g[f],c||"data-lazyload-src-custom")}})}});m.mix(l,l.prototype,true,["loadCustomLazyData","_loadImgSrc","_loadDataFromArea"]);m.DataLazyload=l});
