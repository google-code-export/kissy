/*
Copyright 2010, KISSY UI Library v1.0.5
MIT Licensed
build: 526 Apr 6 18:02
*/
KISSY.add("datalazyload",function(e,w){function m(a,b){if(!(this instanceof m))return new m(a,b);if(b===w){b=a;a=[p]}e.isArray(a)||(a=[e.get(a)||p]);this.containers=a;this.config=e.merge(x,b||{});this.callbacks={els:[],fns:[]};this._init()}var s=e.DOM,n=e.Event,k=YAHOO.util.Dom,o=window,p=document,t={AUTO:"auto",MANUAL:"manual"},x={mod:t.MANUAL,diff:"default",placeholder:"http://a.tbcdn.cn/kissy/1.0.4/build/datalazyload/dot.gif"},u=m.prototype;e.mix(u,{_init:function(){this.threshold=this._getThreshold();
this._filterItems();this._getItemsLength()&&this._initLoadEvent()},_initLoadEvent:function(){function a(){c||(c=setTimeout(function(){b();c=null},100))}function b(){d._loadItems();if(d._getItemsLength()===0){n.remove(o,"scroll",a);n.remove(o,"resize",a)}}var c,d=this;n.on(o,"scroll",a);n.on(o,"resize",function(){d.threshold=d._getThreshold();a()});d._getItemsLength()&&e.ready(function(){b()})},_filterItems:function(){var a=this.containers,b=this.threshold,c=this.config.placeholder,d=this.config.mod===
t.MANUAL,f,h,g,i,l,j,q,r=[],v=[];f=0;for(h=a.length;f<h;++f){g=e.query("img",a[f]);i=0;for(l=g.length;i<l;++i){j=g[i];q=j.getAttribute("data-lazyload-src");if(d){if(q){j.src=c;r.push(j)}}else if(k.getY(j)>b&&!q){j.setAttribute("data-lazyload-src",j.src);j.src=c;r.push(j)}}g=e.query("textarea",a[f]);i=0;for(l=g.length;i<l;++i){j=g[i];s.hasClass(j,"ks-datalazyload")&&v.push(j)}}this.images=r;this.areaes=v},_loadItems:function(){this._loadImgs();this._loadAreaes();this._fireCallbacks()},_loadImgs:function(){var a=
this.images,b=this.threshold+k.getDocumentScrollTop(),c,d,f=[];for(c=0;d=a[c++];)k.getY(d)<=b?this._loadImgSrc(d):f.push(d);this.images=f},_loadImgSrc:function(a,b){b=b||"data-lazyload-src";var c=a.getAttribute(b);if(c&&a.src!=c){a.src=c;a.removeAttribute(b)}},_loadAreaes:function(){var a=this.areaes,b=this.threshold+k.getDocumentScrollTop(),c,d,f,h=[];for(c=0;d=a[c++];){f=d.parentNode;k.getY(f)<=b?this._loadDataFromArea(f,d):h.push(d)}this.areaes=h},_loadDataFromArea:function(a,b){var c=p.createElement("DIV");
c.innerHTML=b.value;b.style.display="none";b.className="";a.appendChild(c);e.UA.gecko||e.query("script",c).each(function(d){e.globalEval(d.text)})},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,d=this.threshold+k.getDocumentScrollTop(),f,h,g,i=[],l=[];for(f=0;(h=b[f])&&(g=c[f++]);)if(k.getY(h)<=d)g.call(h);else{i.push(h);l.push(g)}a.els=i;a.fns=l},addCallback:function(a,b){if((a=e.get(a))&&typeof b==="function"){this.callbacks.els.push(a);this.callbacks.fns.push(b)}},_getThreshold:function(){var a=
this.config.diff,b=k.getViewportHeight();return a==="default"?2*b:b+a},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var d=this,f,h;e.isArray(a)||(a=[e.get(a)]);e.each(a,function(g){switch(b){case "textarea-data":if((f=e.get("textarea",g))&&s.hasClass(f,c||"ks-datalazyload-custom"))d._loadDataFromArea(g,f);break;default:h=g.nodeName==="IMG"?[g]:e.query("img",g);g=0;for(var i=h.length;g<i;g++)d._loadImgSrc(h[g],
c||"data-lazyload-src-custom")}})}});e.mix(m,u,true,["loadCustomLazyData","_loadImgSrc","_loadDataFromArea"]);e.DataLazyload=m});
