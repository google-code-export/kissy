/*
Copyright 2010, KISSY UI Library v1.0.8
MIT Licensed
build: 846 Jul 11 00:09
*/
KISSY.add("datalazyload",function(d,m){function j(a,b){if(!(this instanceof j))return new j(a,b);if(b===m){b=a;a=[n]}d.isArray(a)||(a=[d.get(a)||n]);this.containers=a;this.config=d.merge(q,b||{});this.callbacks={els:[],fns:[]};this._init()}var f=d.DOM,k=d.Event,l=window,n=document,o={AUTO:"auto",MANUAL:"manual"},q={mod:o.MANUAL,diff:"default",placeholder:"none"},p=j.prototype;d.augment(p,{_init:function(){this.threshold=this._getThreshold();this._filterItems();this._getItemsLength()&&this._initLoadEvent()},
_initLoadEvent:function(){function a(){c||(c=setTimeout(function(){b();c=null},100))}function b(){e._loadItems();if(e._getItemsLength()===0){k.remove(l,"scroll",a);k.remove(l,"resize",a)}}var c,e=this;k.on(l,"scroll",a);k.on(l,"resize",function(){e.threshold=e._getThreshold();a()});e._getItemsLength()&&d.ready(function(){b()})},_filterItems:function(){var a=this.containers,b,c,e,h=[],i=[];b=0;for(c=a.length;b<c;++b){e=d.query("img",a[b]);h=h.concat(d.filter(e,this._filterInitialImg,this));e=d.query("textarea",
a[b]);i=i.concat(d.filter(e,this._filterArea,this))}this.images=h;this.areas=i},_filterArea:function(a){return f.hasClass(a,"ks-datalazyload")},_filterInitialImg:function(a){var b=a.getAttribute("data-lazyload-src"),c=this.threshold,e=this.config.placeholder;if(this.config.mod===o.MANUAL){if(b){if(e!=="none")a.src=e;return true}}else if(f.offset(a).top>c&&!b){a.setAttribute("data-lazyload-src",a.src);if(e!=="none")a.src=e;return true}},_loadItems:function(){this._loadImgs();this._loadAreas()},_filterImg:function(a){var b=
this.threshold+f.scrollTop();if(f.offset(a).top<=b)this._loadImgSrc(a);else return true},_loadImgs:function(){this.images=d.filter(this.images,this._filterImg,this)},_loadImgSrc:function(a,b){b=b||"data-lazyload-src";var c=a.getAttribute(b);if(c&&a.src!=c){a.src=c;a.removeAttribute(b);this.fire("show",{el:a})}},_filterAreas:function(a){var b=a,c=this.threshold+f.scrollTop();b=f.offset(a).top;if(b===m){b=a.parentNode;b=f.offset(b).top}if(b<=c)this._loadDataFromArea(a.parentNode,a);else return true},
_loadAreas:function(){this.areas=d.filter(this.areas,this._filterAreas,this)},_loadDataFromArea:function(a,b){var c=f.create("<div></div>");b.style.display="none";b.className="";a.insertBefore(c,b);f.html(c,b.value,true);this.fire("show",{el:c})},_getThreshold:function(){var a=this.config.diff,b=f.viewportHeight();return a==="default"?2*b:b+a},_getItemsLength:function(){return this.images.length+this.areas.length},loadCustomLazyData:function(a,b,c){var e=this,h,i;d.isArray(a)||(a=[d.get(a)]);d.each(a,
function(g){switch(b){case "textarea-data":if((h=d.get("textarea",g))&&f.hasClass(h,c||"ks-datalazyload-custom"))e._loadDataFromArea(g,h);break;default:i=g.nodeName==="IMG"?[g]:d.query("img",g);g=0;for(var r=i.length;g<r;g++)e._loadImgSrc(i[g],c||"data-lazyload-src-custom")}})}});d.mix(j,p,true,["loadCustomLazyData","_loadImgSrc","_loadDataFromArea"]);d.DataLazyload=j});
