if(typeof KISSY==="undefined"||!KISSY){KISSY={}}(function(e){var b=YAHOO.util,j=b.Dom,o=b.Event,k=YAHOO.lang,n=document.getElementsByTagName("head")[0],a=YAHOO.env.ua.ie,f=(a===6),h="KISSY.Suggest.callback",m="suggest-style",i="beforeDataRequest",l="onDataReturn",d="beforeShow",c="onItemSelect",g={containerClassName:"suggest-container",containerWidth:"auto",keyElClassName:"suggest-key",resultElClassName:"suggest-result",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",selectedItemClassName:"selected",bottomClassName:"suggest-bottom",showCloseBtn:false,closeBtnText:"\u5173\u95ed",closeBtnClassName:"suggest-close-btn",useShim:f,shimClassName:"suggest-shim",timerDelay:200,autoFocus:false,submitFormOnClickSelect:true};e.Suggest=function(q,r,p){this.textInput=j.get(q);this.dataSource=r;this.JSONDataSource=k.isObject(r)?r:null;this.returnedData=null;this.config=k.merge(g,p||{});this.container=null;this.query="";this.queryParams="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._scriptDataIsOut=false;this._onKeyboardSelecting=false;this.selectedItem=null;this._init()};e.Suggest.prototype={_init:function(){this._initTextInput();this._initContainer();if(this.config.useShim){this._initShim()}this._initStyle();this.createEvent(i);this.createEvent(l);this.createEvent(d);this.createEvent(c);this._initResizeEvent()},_initTextInput:function(){var p=this;this.textInput.setAttribute("autocomplete","off");o.on(this.textInput,"focus",function(){p.start()});o.on(this.textInput,"blur",function(){p.stop();p.hide()});if(this.config.autoFocus){this.textInput.focus()}var q=0;o.on(this.textInput,"keydown",function(r){var s=r.charCode||r.keyCode;switch(s){case 27:p.hide();p.textInput.value=p.query;break;case 13:p.textInput.blur();if(p._onKeyboardSelecting){if(p.textInput.value==p._getSelectedItemKey()){p.fireEvent(c,p.textInput.value)}}p._submitForm();break;case 40:case 38:if(q++==0){if(p._isRunning){p.stop()}p._onKeyboardSelecting=true;p.selectItem(s==40)}else{if(q==3){q=0}}break}if(s!=40&&s!=38){if(!p._isRunning){p.start()}p._onKeyboardSelecting=false}});o.on(this.textInput,"keyup",function(){q=0})},_initContainer:function(){var p=document.createElement("div");p.className=this.config.containerClassName;p.style.position="absolute";p.style.visibility="hidden";this.container=p;this._setContainerRegion();this._initContainerEvent();document.body.insertBefore(p,document.body.firstChild)},_setContainerRegion:function(){var s=j.getRegion(this.textInput);var t=s.left,p=s.right-t-2;var q=document.documentMode;if(q===7&&(a===7||a===8)){t-=2}else{if(YAHOO.env.ua.gecko){t++}}this.container.style.left=t+"px";this.container.style.top=s.bottom+"px";if(this.config.containerWidth=="auto"){this.container.style.width=p+"px"}else{this.container.style.width=this.config.containerWidth}},_initContainerEvent:function(){var p=this;o.on(this.container,"mousemove",function(r){var s=o.getTarget(r);if(s.nodeName!="LI"){s=j.getAncestorByTagName(s,"li")}if(j.isAncestor(p.container,s)){if(s!=p.selectedItem){p._removeSelectedItem();p._setSelectedItem(s)}}});var q=null;this.container.onmousedown=function(r){r=r||window.event;q=r.target||r.srcElement;p.textInput.onbeforedeactivate=function(){window.event.returnValue=false;p.textInput.onbeforedeactivate=null};return false};o.on(this.container,"mouseup",function(r){if(!p._isInContainer(o.getXY(r))){return}var s=o.getTarget(r);if(s!=q){return}if(s.className==p.config.closeBtnClassName){p.hide();return}if(s.nodeName!="LI"){s=j.getAncestorByTagName(s,"li")}if(j.isAncestor(p.container,s)){p._updateInputFromSelectItem(s);p.fireEvent(c,p.textInput.value);p.textInput.blur();p._submitForm()}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var q=this.textInput.form;if(!q){return}if(document.createEvent){var p=document.createEvent("MouseEvents");p.initEvent("submit",true,false);q.dispatchEvent(p)}else{if(document.createEventObject){q.fireEvent("onsubmit")}}q.submit()}},_isInContainer:function(s){var q=j.getRegion(this.container);return s[0]>=q.left&&s[0]<=q.right&&s[1]>=q.top&&s[1]<=q.bottom},_initShim:function(){var p=document.createElement("iframe");p.src="about:blank";p.className=this.config.shimClassName;p.style.position="absolute";p.style.visibility="hidden";p.style.border="none";this.container.shim=p;this._setShimRegion();document.body.insertBefore(p,document.body.firstChild)},_setShimRegion:function(){var p=this.container,q=p.shim;if(q){q.style.left=(parseInt(p.style.left)-2)+"px";q.style.top=p.style.top;q.style.width=(parseInt(p.style.width)+2)+"px"}},_initStyle:function(){var q=j.get(m);if(q){return}var p=".suggest-container{background:white;border:1px solid #999;z-index:99999}";p+=".suggest-shim{z-index:99998}";p+=".suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}";p+=".suggest-container li.selected{background-color:#39F;cursor:default}";p+=".suggest-key{float:left;text-align:left;padding-left:5px}";p+=".suggest-result{float:right;text-align:right;padding-right:5px;color:green}";p+=".suggest-container li.selected span{color:#FFF;cursor:default}";p+=".suggest-bottom{padding:0 5px 5px}";p+=".suggest-close-btn{float:right}";p+=".suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}";p+=".suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}";q=document.createElement("style");q.id=m;q.type="text/css";n.appendChild(q);if(q.styleSheet){q.styleSheet.cssText=p}else{q.appendChild(document.createTextNode(p))}},_initResizeEvent:function(){var q=this,p;o.on(window,"resize",function(){if(p){clearTimeout(p)}p=setTimeout(function(){q._setContainerRegion();q._setShimRegion()},50)})},start:function(){e.Suggest.focusInstance=this;var p=this;p._timer=setTimeout(function(){p.updateData();p._timer=setTimeout(arguments.callee,p.config.timerDelay)},p.config.timerDelay);this._isRunning=true},stop:function(){e.Suggest.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){if(this.isVisible()){return}var p=this.container,s=p.shim;p.style.visibility="";if(s){if(!s.style.height){var q=j.getRegion(p);s.style.height=(q.bottom-q.top-2)+"px"}s.style.visibility=""}},hide:function(){if(!this.isVisible()){return}var p=this.container,q=p.shim;if(q){q.style.visibility="hidden"}p.style.visibility="hidden"},isVisible:function(){return this.container.style.visibility!="hidden"},updateData:function(){if(!this._needUpdate()){return}this._updateQueryValueFromInput();var p=this.query;if(!k.trim(p).length){this._fillContainer("");this.hide();return}if(typeof this._dataCache[p]!="undefined"){this.returnedData="using cache";this._fillContainer(this._dataCache[p]);this._displayContainer()}else{if(this.JSONDataSource){this.handleResponse(this.JSONDataSource[p])}else{this.requestData()}}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){if(!a){this.dataScript=null}if(!this.dataScript){var p=document.createElement("script");p.type="text/javascript";p.charset="utf-8";n.insertBefore(p,n.firstChild);this.dataScript=p;if(!a){var q=new Date().getTime();this._latestScriptTime=q;p.setAttribute("time",q);o.on(p,"load",function(){this._scriptDataIsOut=p.getAttribute("time")!=this._latestScriptTime},this,true)}}this.queryParams="q="+encodeURIComponent(this.query)+"&code=utf-8&callback="+h;this.fireEvent(i,this.query);this.dataScript.src=this.dataSource+"?"+this.queryParams},handleResponse:function(v){if(this._scriptDataIsOut){return}this.returnedData=v;this.fireEvent(l,v);this.returnedData=this.formatData(this.returnedData);var t="";var r=this.returnedData.length;if(r>0){var u=document.createElement("ol");for(var s=0;s<r;++s){var q=this.returnedData[s];var p=this.formatItem(q.key,q.result);p.setAttribute("key",q.key);u.appendChild(p)}t=u}this._fillContainer(t);if(r>0){this.appendBottom()}if(k.trim(this.container.innerHTML)){this.fireEvent(d,this.container)}this._dataCache[this.query]=this.container.innerHTML;this._displayContainer()},formatData:function(t){var q=[];if(!t){return q}if(k.isArray(t.result)){t=t.result}var p=t.length;if(!p){return q}var s;for(var r=0;r<p;++r){s=t[r];if(k.isString(s)){q[r]={key:s}}else{if(k.isArray(s)&&s.length>=2){q[r]={key:s[0],result:s[1]}}else{q[r]=s}}}return q},formatItem:function(r,q){var p=document.createElement("li");var t=document.createElement("span");t.className=this.config.keyElClassName;t.appendChild(document.createTextNode(r));p.appendChild(t);if(typeof q!="undefined"){var s=this.config.resultFormat.replace("%result%",q);if(k.trim(s)){var u=document.createElement("span");u.className=this.config.resultElClassName;u.appendChild(document.createTextNode(s));p.appendChild(u)}}return p},appendBottom:function(){var p=document.createElement("div");p.className=this.config.bottomClassName;if(this.config.showCloseBtn){var q=document.createElement("a");q.href="javascript: void(0)";q.setAttribute("target","_self");q.className=this.config.closeBtnClassName;q.appendChild(document.createTextNode(this.config.closeBtnText));p.appendChild(q)}if(k.trim(p.innerHTML)){this.container.appendChild(p)}},_fillContainer:function(p){if(p.nodeType==1){this.container.innerHTML="";this.container.appendChild(p)}else{this.container.innerHTML=p}this.selectedItem=null},_displayContainer:function(){if(k.trim(this.container.innerHTML)){this.show()}else{this.hide()}},selectItem:function(r){var q=this.container.getElementsByTagName("li");if(q.length==0){return}if(!this.isVisible()){this.show();return}var p;if(!this.selectedItem){p=q[r?0:q.length-1]}else{p=j[r?"getNextSibling":"getPreviousSibling"](this.selectedItem);if(!p){this.textInput.value=this.query}}this._removeSelectedItem();if(p){this._setSelectedItem(p);this._updateInputFromSelectItem()}},_removeSelectedItem:function(){j.removeClass(this.selectedItem,this.config.selectedItemClassName);this.selectedItem=null},_setSelectedItem:function(p){j.addClass((p),this.config.selectedItemClassName);this.selectedItem=(p)},_getSelectedItemKey:function(){if(!this.selectedItem){return""}return this.selectedItem.getAttribute("key")},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)}};k.augmentProto(e.Suggest,b.EventProvider);e.Suggest.focusInstance=null;e.Suggest.callback=function(p){if(!e.Suggest.focusInstance){return}setTimeout(function(){e.Suggest.focusInstance.handleResponse(p)},0)}})(KISSY);
