if(typeof KISSY==="undefined"||!KISSY){KISSY={}}(function(s){var c=YAHOO.util,b=c.Dom,w=c.Event,d=YAHOO.lang,e=document.getElementsByTagName("head")[0],o=YAHOO.env.ua.ie,h=(o===6),q="KISSY.Suggest.callback",l="suggest-style",m="beforeDataRequest",j="onDataReturn",f="beforeShow",r="onItemSelect",u="absolute",t="hidden",k="none",i="px",v="undefined",a="span",g="li",p="div",n={containerClassName:"suggest-container",containerWidth:"auto",keyElClassName:"suggest-key",resultElClassName:"suggest-result",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",selectedItemClassName:"selected",bottomClassName:"suggest-bottom",showCloseBtn:false,closeBtnText:"\u5173\u95ed",closeBtnClassName:"suggest-close-btn",useShim:h,shimClassName:"suggest-shim",timerDelay:200,autoFocus:false,submitFormOnClickSelect:true};s.Suggest=function(y,z,x){this.textInput=b.get(y);this.dataSource=z;this.JSONDataSource=d.isObject(z)?z:null;this.returnedData=null;this.config=d.merge(n,x||{});this.container=null;this.query="";this.queryParams="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._scriptDataIsOut=false;this._onKeyboardSelecting=false;this.selectedItem=null;this._init()};s.Suggest.prototype={_init:function(){this._initTextInput();this._initContainer();if(this.config.useShim){this._initShim()}this._initStyle();this.createEvent(m);this.createEvent(j);this.createEvent(f);this.createEvent(r);this._initResizeEvent()},_initTextInput:function(){var x=this;this.textInput.setAttribute("autocomplete","off");w.on(this.textInput,"focus",function(){x.start()});w.on(this.textInput,"blur",function(){x.stop();x.hide()});if(this.config.autoFocus){this.textInput.focus()}var y=0;w.on(this.textInput,"keydown",function(z){var A=z.charCode||z.keyCode;switch(A){case 27:x.hide();x.textInput.value=x.query;break;case 13:x.textInput.blur();if(x._onKeyboardSelecting){if(x.textInput.value==x._getSelectedItemKey()){x.fireEvent(r,x.textInput.value)}}x._submitForm();break;case 40:case 38:if(y++==0){if(x._isRunning){x.stop()}x._onKeyboardSelecting=true;x.selectItem(A==40)}else{if(y==3){y=0}}break}if(A!=40&&A!=38){if(!x._isRunning){x.start()}x._onKeyboardSelecting=false}});w.on(this.textInput,"keyup",function(){y=0})},_initContainer:function(){var x=document.createElement(p);x.className=this.config.containerClassName;x.style.position=u;x.style.visibility=t;this.container=x;this._setContainerRegion();this._initContainerEvent();document.body.insertBefore(x,document.body.firstChild)},_setContainerRegion:function(){var z=b.getRegion(this.textInput);var A=z.left,x=z.right-A-2;var y=document.documentMode;if(y===7&&(o===7||o===8)){A-=2}else{if(YAHOO.env.ua.gecko){A++}}this.container.style.left=A+i;this.container.style.top=z.bottom+i;if(this.config.containerWidth=="auto"){this.container.style.width=x+i}else{this.container.style.width=this.config.containerWidth}},_initContainerEvent:function(){var x=this;w.on(this.container,"mousemove",function(z){var A=w.getTarget(z);if(A.nodeName!="LI"){A=b.getAncestorByTagName(A,g)}if(b.isAncestor(x.container,A)){if(A!=x.selectedItem){x._removeSelectedItem();x._setSelectedItem(A)}}});var y=null;this.container.onmousedown=function(z){z=z||window.event;y=z.target||z.srcElement;x.textInput.onbeforedeactivate=function(){window.event.returnValue=false;x.textInput.onbeforedeactivate=null};return false};w.on(this.container,"mouseup",function(z){if(!x._isInContainer(w.getXY(z))){return}var A=w.getTarget(z);if(A!=y){return}if(A.className==x.config.closeBtnClassName){x.hide();return}if(A.nodeName!="LI"){A=b.getAncestorByTagName(A,g)}if(b.isAncestor(x.container,A)){x._updateInputFromSelectItem(A);x.fireEvent(r,x.textInput.value);x.textInput.blur();x._submitForm()}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var y=this.textInput.form;if(!y){return}if(document.createEvent){var x=document.createEvent("MouseEvents");x.initEvent("submit",true,false);y.dispatchEvent(x)}else{if(document.createEventObject){y.fireEvent("onsubmit")}}y.submit()}},_isInContainer:function(y){var x=b.getRegion(this.container);return y[0]>=x.left&&y[0]<=x.right&&y[1]>=x.top&&y[1]<=x.bottom},_initShim:function(){var x=document.createElement("iframe");x.src="about:blank";x.className=this.config.shimClassName;x.style.position=u;x.style.visibility=t;x.style.border=k;this.container.shim=x;this._setShimRegion();document.body.insertBefore(x,document.body.firstChild)},_setShimRegion:function(){var x=this.container,y=x.shim;if(y){y.style.left=(parseInt(x.style.left)-2)+i;y.style.top=x.style.top;y.style.width=(parseInt(x.style.width)+2)+i}},_initStyle:function(){var y=b.get(l);if(y){return}var x=".suggest-container{background:white;border:1px solid #999;z-index:99999}";x+=".suggest-shim{z-index:99998}";x+=".suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}";x+=".suggest-container li.selected{background-color:#39F;cursor:default}";x+=".suggest-key{float:left;text-align:left;padding-left:5px}";x+=".suggest-result{float:right;text-align:right;padding-right:5px;color:green}";x+=".suggest-container li.selected span{color:#FFF;cursor:default}";x+=".suggest-bottom{padding:0 5px 5px}";x+=".suggest-close-btn{float:right}";x+=".suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}";x+=".suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}";y=document.createElement("style");y.id=this.config.styleElId;y.type="text/css";e.appendChild(y);if(y.styleSheet){y.styleSheet.cssText=x}else{y.appendChild(document.createTextNode(x))}},_initResizeEvent:function(){var y=this,x;w.on(window,"resize",function(){if(x){clearTimeout(x)}x=setTimeout(function(){y._setContainerRegion();y._setShimRegion()},50)})},start:function(){s.Suggest.focusInstance=this;var x=this;x._timer=setTimeout(function(){x.updateData();x._timer=setTimeout(arguments.callee,x.config.timerDelay)},x.config.timerDelay);this._isRunning=true},stop:function(){s.Suggest.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){if(this.isVisible()){return}var x=this.container,z=x.shim;x.style.visibility="";if(z){if(!z.style.height){var y=b.getRegion(x);z.style.height=(y.bottom-y.top-2)+i}z.style.visibility=""}},hide:function(){if(!this.isVisible()){return}var x=this.container,y=x.shim;if(y){y.style.visibility=t}x.style.visibility=t},isVisible:function(){return this.container.style.visibility!=t},updateData:function(){if(!this._needUpdate()){return}this._updateQueryValueFromInput();var x=this.query;if(!d.trim(x).length){this._fillContainer("");this.hide();return}if(typeof this._dataCache[x]!=v){this.returnedData="using cache";this._fillContainer(this._dataCache[x]);this._displayContainer()}else{if(this.JSONDataSource){this.handleResponse(this.JSONDataSource[x])}else{this.requestData()}}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){if(!o){this.dataScript=null}if(!this.dataScript){var x=document.createElement("script");x.type="text/javascript";x.charset="utf-8";e.insertBefore(x,e.firstChild);this.dataScript=x;if(!o){var y=new Date().getTime();this._latestScriptTime=y;x.setAttribute("time",y);w.on(x,"load",function(){this._scriptDataIsOut=x.getAttribute("time")!=this._latestScriptTime},this,true)}}this.queryParams="q="+encodeURIComponent(this.query)+"&code=utf-8&callback="+q;this.fireEvent(m,this.query);this.dataScript.src=this.dataSource+"?"+this.queryParams},handleResponse:function(D){if(this._scriptDataIsOut){return}this.returnedData=D;this.fireEvent(j,D);this.returnedData=this.formatData(this.returnedData);var B="";var z=this.returnedData.length;if(z>0){var C=document.createElement("ol");for(var A=0;A<z;++A){var y=this.returnedData[A];var x=this.formatItem(y.key,y.result);x.setAttribute("key",y.key);C.appendChild(x)}B=C}this._fillContainer(B);if(z>0){this.appendBottom()}if(d.trim(this.container.innerHTML)){this.fireEvent(f,this.container)}this._dataCache[this.query]=this.container.innerHTML;this._displayContainer()},formatData:function(B){var y=[];if(!B){return y}if(d.isArray(B.result)){B=B.result}var x=B.length;if(!x){return y}var A;for(var z=0;z<x;++z){A=B[z];if(d.isString(A)){y[z]={key:A}}else{if(d.isArray(A)&&A.length>=2){y[z]={key:A[0],result:A[1]}}else{y[z]=A}}}return y},formatItem:function(z,y){var x=document.createElement(g);var B=document.createElement(a);B.className=this.config.keyElClassName;B.appendChild(document.createTextNode(z));x.appendChild(B);if(typeof y!=v){var A=this.config.resultFormat.replace("%result%",y);if(d.trim(A)){var C=document.createElement(a);C.className=this.config.resultElClassName;C.appendChild(document.createTextNode(A));x.appendChild(C)}}return x},appendBottom:function(){var x=document.createElement(p);x.className=this.config.bottomClassName;if(this.config.showCloseBtn){var y=document.createElement("a");y.href="javascript: void(0)";y.setAttribute("target","_self");y.className=this.config.closeBtnClassName;y.appendChild(document.createTextNode(this.config.closeBtnText));x.appendChild(y)}if(d.trim(x.innerHTML)){this.container.appendChild(x)}},_fillContainer:function(x){if(x.nodeType==1){this.container.innerHTML="";this.container.appendChild(x)}else{this.container.innerHTML=x}this.selectedItem=null},_displayContainer:function(){if(d.trim(this.container.innerHTML)){this.show()}else{this.hide()}},selectItem:function(z){var y=this.container.getElementsByTagName(g);if(y.length==0){return}if(!this.isVisible()){this.show();return}var x;if(!this.selectedItem){x=y[z?0:y.length-1]}else{x=b[z?"getNextSibling":"getPreviousSibling"](this.selectedItem);if(!x){this.textInput.value=this.query}}this._removeSelectedItem();if(x){this._setSelectedItem(x);this._updateInputFromSelectItem()}},_removeSelectedItem:function(){b.removeClass(this.selectedItem,this.config.selectedItemClassName);this.selectedItem=null},_setSelectedItem:function(x){b.addClass((x),this.config.selectedItemClassName);this.selectedItem=(x)},_getSelectedItemKey:function(){if(!this.selectedItem){return""}return this.selectedItem.getAttribute("key")},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)}};d.augmentProto(s.Suggest,c.EventProvider);s.Suggest.focusInstance=null;s.Suggest.callback=function(x){if(!s.Suggest.focusInstance){return}setTimeout(function(){s.Suggest.focusInstance.handleResponse(x)},0)}})(KISSY);
