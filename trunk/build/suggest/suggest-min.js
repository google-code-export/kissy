/*
Copyright 2010, KISSY UI Library v1.0dev
MIT Licensed
build: 413 Jan 17 21:04
*/
KISSY.add("suggest",function(m){m.Suggest=KISSY.Suggest?KISSY.Suggest:(KISSY.Suggest=function(){function i(a,b,c){if(!(this instanceof arguments.callee))return new arguments.callee(a,b,c);this.textInput=f.get(a);this.dataSource=b;this.JSONDataSource=g.isObject(b)?b:null;this.returnedData=null;this.config=g.merge(p,c||{});this.container=null;this.queryParams=this.query="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._onKeyboardSelecting=
this._scriptDataIsOut=false;this.selectedItem=null;this._init()}var n=YAHOO.util,f=n.Dom,h=n.Event,g=YAHOO.lang,l=window,d=document,o=d.getElementsByTagName("head")[0],k=YAHOO.env.ua.ie,p={containerClass:"",containerWidth:"auto",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",showCloseBtn:false,closeBtnText:"\u5173\u95ed",useShim:k===6,timerDelay:200,autoFocus:false,submitFormOnClickSelect:true};m.mix(i.prototype,{_init:function(){this._initTextInput();this._initContainer();this.config.useShim&&this._initShim();this._initStyle();
this.createEvent("beforeDataRequest");this.createEvent("onDataReturn");this.createEvent("beforeShow");this.createEvent("onItemSelect");this._initResizeEvent()},_initTextInput:function(){var a=this;this.textInput.setAttribute("autocomplete","off");h.on(this.textInput,"blur",function(){a.stop();a.hide()});this.config.autoFocus&&this.textInput.focus();var b=0;h.on(this.textInput,"keydown",function(c){c=c.keyCode;switch(c){case 27:a.hide();a.textInput.value=a.query;break;case 13:a.textInput.blur();a._onKeyboardSelecting&&
a.textInput.value==a._getSelectedItemKey()&&a.fireEvent("onItemSelect",a.textInput.value);a._submitForm();break;case 40:case 38:if(b++==0){a._isRunning&&a.stop();a._onKeyboardSelecting=true;a.selectItem(c==40)}else if(b==3)b=0;break}if(c!=40&&c!=38){a._isRunning||a.start();a._onKeyboardSelecting=false}});h.on(this.textInput,"keyup",function(){b=0})},_initContainer:function(){var a=d.createElement("div"),b=this.config.containerClass;a.className="suggest-container";if(b)a.className+=" "+b;a.style.position=
"absolute";a.style.visibility="hidden";this.container=a;this._setContainerRegion();this._initContainerEvent();d.body.insertBefore(a,d.body.firstChild)},_setContainerRegion:function(){var a=f.getRegion(this.textInput),b=a.left,c=a.right-b-2;c=c>0?c:0;if(d.documentMode===7&&(k===7||k===8))b-=2;else YAHOO.env.ua.gecko&&b++;this.container.style.left=b+"px";this.container.style.top=a.bottom+"px";this.container.style.width=this.config.containerWidth=="auto"?c+"px":this.config.containerWidth},_initContainerEvent:function(){var a=
this;h.on(this.container,"mousemove",function(c){c=h.getTarget(c);if(c.nodeName!="LI")c=f.getAncestorByTagName(c,"li");if(f.isAncestor(a.container,c))if(c!=a.selectedItem){a._removeSelectedItem();a._setSelectedItem(c)}});var b=null;this.container.onmousedown=function(c){c=c||l.event;b=c.target||c.srcElement;a.textInput.onbeforedeactivate=function(){l.event.returnValue=false;a.textInput.onbeforedeactivate=null};return false};h.on(this.container,"mouseup",function(c){if(a._isInContainer(h.getXY(c))){c=
h.getTarget(c);if(c==b)if(c.className=="suggest-close-btn")a.hide();else{if(c.nodeName!="LI")c=f.getAncestorByTagName(c,"li");if(f.isAncestor(a.container,c)){a._updateInputFromSelectItem(c);a.fireEvent("onItemSelect",a.textInput.value);a.textInput.blur();a._submitForm()}}}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var a=this.textInput.form;if(a){if(d.createEvent){var b=d.createEvent("MouseEvents");b.initEvent("submit",true,false);a.dispatchEvent(b)}else d.createEventObject&&
a.fireEvent("onsubmit");a.submit()}}},_isInContainer:function(a){var b=f.getRegion(this.container);return a[0]>=b.left&&a[0]<=b.right&&a[1]>=b.top&&a[1]<=b.bottom},_initShim:function(){var a=d.createElement("iframe");a.src="about:blank";a.className="suggest-shim";a.style.position="absolute";a.style.visibility="hidden";a.style.border="none";this.container.shim=a;this._setShimRegion();d.body.insertBefore(a,d.body.firstChild)},_setShimRegion:function(){var a=this.container,b=a.shim;if(b){b.style.left=
parseInt(a.style.left)-2+"px";b.style.top=a.style.top;b.style.width=parseInt(a.style.width)+2+"px"}},_initStyle:function(){var a=f.get("suggest-style");if(!a){a=d.createElement("style");a.id="suggest-style";a.type="text/css";o.appendChild(a);if(a.styleSheet)a.styleSheet.cssText=".suggest-container{background:white;border:1px solid #999;z-index:99999}.suggest-shim{z-index:99998}.suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}.suggest-container li.selected{background-color:#39F;cursor:default}.suggest-key{float:left;text-align:left;padding-left:5px}.suggest-result{float:right;text-align:right;padding-right:5px;color:green}.suggest-container li.selected span{color:#FFF;cursor:default}.suggest-bottom{padding:0 5px 5px}.suggest-close-btn{float:right}.suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}.suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}";
else a.appendChild(d.createTextNode(".suggest-container{background:white;border:1px solid #999;z-index:99999}.suggest-shim{z-index:99998}.suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}.suggest-container li.selected{background-color:#39F;cursor:default}.suggest-key{float:left;text-align:left;padding-left:5px}.suggest-result{float:right;text-align:right;padding-right:5px;color:green}.suggest-container li.selected span{color:#FFF;cursor:default}.suggest-bottom{padding:0 5px 5px}.suggest-close-btn{float:right}.suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}.suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}"))}},
_initResizeEvent:function(){var a=this,b;h.on(l,"resize",function(){b&&clearTimeout(b);b=setTimeout(function(){a._setContainerRegion();a._setShimRegion()},50)})},start:function(){i.focusInstance=this;var a=this;a._timer=setTimeout(function(){a.updateContent();a._timer=setTimeout(arguments.callee,a.config.timerDelay)},a.config.timerDelay);this._isRunning=true},stop:function(){i.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){if(!this.isVisible()){var a=this.container,
b=a.shim;a.style.visibility="";if(b){if(!b.style.height){a=f.getRegion(a);b.style.height=a.bottom-a.top-2+"px"}b.style.visibility=""}}},hide:function(){if(this.isVisible()){var a=this.container,b=a.shim;if(b)b.style.visibility="hidden";a.style.visibility="hidden"}},isVisible:function(){return this.container.style.visibility!="hidden"},updateContent:function(){if(this._needUpdate()){this._updateQueryValueFromInput();var a=this.query;if(g.trim(a).length)if(typeof this._dataCache[a]!="undefined"){this.returnedData=
"using cache";this._fillContainer(this._dataCache[a]);this._displayContainer()}else this.JSONDataSource?this.handleResponse(this.JSONDataSource[a]):this.requestData();else{this._fillContainer("");this.hide()}}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){if(!k)this.dataScript=null;if(!this.dataScript){var a=d.createElement("script");a.type="text/javascript";a.charset="utf-8";o.insertBefore(a,o.firstChild);this.dataScript=a;if(!k){var b=(new Date).getTime();
this._latestScriptTime=b;a.setAttribute("time",b);h.on(a,"load",function(){this._scriptDataIsOut=a.getAttribute("time")!=this._latestScriptTime},this,true)}}this.queryParams="q="+encodeURIComponent(this.query)+"&code=utf-8&callback=g_ks_suggest_callback";this.fireEvent("beforeDataRequest",this.query);this.dataScript.src=this.dataSource+"?"+this.queryParams},handleResponse:function(a){if(!this._scriptDataIsOut){this.returnedData=a;this.fireEvent("onDataReturn",a);this.returnedData=this.formatData(this.returnedData);
var b="";a=this.returnedData.length;if(a>0){b=d.createElement("ol");for(var c=0;c<a;++c){var e=this.returnedData[c],j=this.formatItem(e.key,e.result);j.setAttribute("key",e.key);b.appendChild(j)}b=b}this._fillContainer(b);a>0&&this.appendBottom();g.trim(this.container.innerHTML)&&this.fireEvent("beforeShow",this.container);this._dataCache[this.query]=this.container.innerHTML;this._displayContainer()}},formatData:function(a){var b=[];if(!a)return b;if(g.isArray(a.result))a=a.result;var c=a.length;
if(!c)return b;for(var e,j=0;j<c;++j){e=a[j];b[j]=g.isString(e)?{key:e}:g.isArray(e)&&e.length>=2?{key:e[0],result:e[1]}:e}return b},formatItem:function(a,b){var c=d.createElement("li"),e=d.createElement("span");e.className="suggest-key";e.appendChild(d.createTextNode(a));c.appendChild(e);if(typeof b!="undefined"){a=this.config.resultFormat.replace("%result%",b);if(g.trim(a)){b=d.createElement("span");b.className="suggest-result";b.appendChild(d.createTextNode(a));c.appendChild(b)}}return c},appendBottom:function(){var a=
d.createElement("div");a.className="suggest-bottom";if(this.config.showCloseBtn){var b=d.createElement("a");b.href="javascript: void(0)";b.setAttribute("target","_self");b.className="suggest-close-btn";b.appendChild(d.createTextNode(this.config.closeBtnText));a.appendChild(b)}g.trim(a.innerHTML)&&this.container.appendChild(a)},_fillContainer:function(a){if(a.nodeType==1){this.container.innerHTML="";this.container.appendChild(a)}else this.container.innerHTML=a;this.selectedItem=null},_displayContainer:function(){g.trim(this.container.innerHTML)?
this.show():this.hide()},selectItem:function(a){var b=this.container.getElementsByTagName("li");if(b.length!=0)if(this.isVisible()){if(this.selectedItem){a=f[a?"getNextSibling":"getPreviousSibling"](this.selectedItem);if(!a)this.textInput.value=this.query}else a=b[a?0:b.length-1];this._removeSelectedItem();if(a){this._setSelectedItem(a);this._updateInputFromSelectItem()}}else this.show()},_removeSelectedItem:function(){f.removeClass(this.selectedItem,"selected");this.selectedItem=null},_setSelectedItem:function(a){f.addClass(a,
"selected");this.selectedItem=a},_getSelectedItemKey:function(){if(!this.selectedItem)return"";return this.selectedItem.getAttribute("key")},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)}});m.augment(i,n.EventProvider);l.g_ks_suggest_callback=function(a){i.focusInstance&&setTimeout(function(){i.focusInstance.handleResponse(a)},0)};return i}())});
