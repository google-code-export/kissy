/*
Copyright (c) 2009, Kissy UI Library. All rights reserved.
MIT Licensed.
http://kissy.googlecode.com/

Date: 2009-12-10 23:31:39
Revision: 298
*/
KISSY.add("imglazyload",function(f){var b=YAHOO.util,g=b.Dom,j=b.Event,i=YAHOO.lang,a="data-lazyload-src",d={AUTO:"auto",MANUAL:"manual"},h="default",e={mod:d.AUTO,diff:h,placeholder:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"};function c(l,k){if(!(this instanceof arguments.callee)){return new arguments.callee(l,k)}if(typeof k==="undefined"){k=l;l=[document]}if(!i.isArray(l)){l=[g.get(l)||document]}this.containers=l;this.config=i.merge(e,k||{});this._init()}f.mix(c.prototype,{_init:function(){this.threshold=this._getThreshold();this.images=this._filterImgs();if(this.images.length>0){this._initLoadEvent()}},_getThreshold:function(){var l=this.config.diff,k=g.getViewportHeight();if(l===h){return 2*k}else{return k+l}},_initLoadEvent:function(){var m,l=this;j.on(window,"scroll",k);j.on(window,"resize",function(){l.threshold=l._getThreshold();k(true)});if(this.config.mod===d.MANUAL){j.onDOMReady(function(){l._loadImgs(true)})}function k(n){if(m){return}m=setTimeout(function(){l._loadImgs(n);if(l.images.length===0){j.removeListener(window,"scroll",k);j.removeListener(window,"resize",k)}m=null},100)}},_filterImgs:function(){var l=this.containers,r=this.threshold,v=this.config.placeholder,m=this.config.mod===d.MANUAL,k,u,q,p,s,o,w,t=[];for(k=0,u=l.length;k<u;++k){q=l[k].getElementsByTagName("img");for(p=0,s=q.length;p<s;++p){o=q[p];w=o.getAttribute(a);if(m){if(w){o.src=v;t.push(o)}}else{if(g.getY(o)>r&&!w){o.setAttribute(a,o.src);o.src=v;t.push(o)}}}}return t},_loadImgs:function(n){var o=g.getDocumentScrollTop();if(!n&&o<=this.config.diff){return}var r=this.images,k=this.threshold+o,m,l,q,p=[];for(m=0;l=r[m++];){if(g.getY(l)<=k){q=l.getAttribute(a);if(q&&l.src!=q){l.src=q;l.removeAttribute(a)}}else{p.push(l)}}this.images=p}});f.ImageLazyload=c});
