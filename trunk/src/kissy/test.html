<!doctype html>
<html>
<head>
<meta charset="gbk"/>
<title>KISSY Core Test</title>
</head>
<body>
<script src="../test/test.js"></script>

<h2>Test Data</h2>
<script src="kissy.js"></script>
<script>
    var S = KISSY,
        doc = document,
        now = function() {
            return new Date().getTime();
        },
        get = function(id) {
            return typeof id === 'string' ? doc.getElementById(id) : id;
        },
        readyTime, loadTime;

    S.ready(function() {
        readyTime = now();
        S.log('readyTime = ' + readyTime);
    });

    window.onload = function() {
        loadTime = now();
        S.log('loadTime = ' + loadTime);
    }
</script>
<img src="../../assets/kissy.png" alt="test image" />
<iframe id="test-iframe" src="test-iframe.html"></iframe>

<!-- Test Cases -->
<script>

    function test_preserve(test) {
        if (!KISSY.Test) test.fail();
    }

    function test_add(test) {
        KISSY.add('test-ks-mod', function(S) {
           S.TestMod = { prop: 1 };
        });

        if(!KISSY.TestMod.prop) test.fail();
        if(KISSY.Env.mods['test-ks-mod'].name !== 'test-ks-mod') test.fail();

        // clear
        delete KISSY.TestMod;
        delete KISSY.Env.mods['test-ks-mod'];
    }

    function test_ready(test) {
        // normal
        var diff = loadTime - readyTime;
        test.extraMsg = 'loadTime - readyTime = ' + diff + 'ms';
        if(diff < 0) test.fail();

        // iframe
        var ifr = get('test-iframe');
        diff = ifr.contentWindow.loadTime - ifr.contentWindow.readyTime;
        if(diff < 0) test.fail();
    }

    function test_mix(test) {
        var S = KISSY,
            o1 = { a: 1, b: 2 },
            o3 = { a: 1, b: 2 },
            o4 = { a: 1, b: 2 },
            o2 = { a: 'a', c: true };

        S.mix(o1, o2);
        S.mix(o3, o2, false);
        S.mix(o4, o2, true, ['c']);

        if(o1.a !== 'a') test.fail();
        if(o3.a !== 1) test.fail();
        if(o4.a !== 1) test.fail();
    }

    function test_merge(test) {
        var S = KISSY,
            a = {
                'bool' : false,
                'num'  : 0,
                'nul'  : null,
                'undef': undefined,
                'T'    : 'blabber'
            },
            b = {
                'bool' : 'oops',
                'num'  : 'oops',
                'nul'  : 'oops',
                'undef': 'oops',
                'T'    : 'oops'
            };

        var c = S.merge(a, b);

        if(c.bool !== 'oops') test.fail();
        if(c.num !== 'oops') test.fail();
        if(c.nul !== 'oops') test.fail();
        if(c.undef !== 'oops') test.fail();
        if(c.T !== 'oops') test.fail();
    }

    function test_extend(test) {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            }
        };

        function Chicken(name) {
            Chicken.superclass.constructor.call(this, name);
        }
        S.extend(Chicken, Bird);

        var chicken = new Chicken('Tom');

        if(chicken.getName() !== 'Tom') test.fail();
    }

    function test_augment(test) {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            },
            fly: function() {
            }
        };

        function Pig(name) {
            this.name = name;
        }
        S.augment(Pig, Bird);

        var pig = new Pig('Babi');

        if(!pig.fly) test.fail();
    }

    function test_weave(test) {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            }
        };

        S.weave(function() {
            this.name = 'Hacked ' + this.name;
        }, 'before', Bird.prototype, 'getName');

        var bird = new Bird('Bird');
        if(bird.getName() !== 'Hacked Bird') test.fail(bird.getName());
    }

    function test_cloneTo(test) {
        var S = KISSY;
        S.cloneTo('TB');

        // check static members
        if(TB.mix !== S.mix) test.fail();
        if(TB.cloneTo !== S.cloneTo) test.fail();

        // check Env and Config
        if(!TB.Env.mods) test.fail();
        if(TB.Config.debug !== true) test.fail();

        // check independence
        TB.test = 2;
        if(S.test === 2) test.fail();
        TB.Config.debug = false;
        if(S.Config.debug !== true) test.fail();

        // test add modules
        TB.add('test-tb-mod', function() { });
        if(!TB.Env.mods['test-tb-mod']) test.fail();
        if(S.Env.mods['test-tb-mod']) test.fail();

        // clear
        window.TB = undefined;
    }

    function test_namespace(test) {
        var S = KISSY, ns;

        // normal
        ns = S.namespace('app.Test');
        ns.name = 'foo1';
        if(S.app.Test.name !== 'foo1') test.fail();

        // first part of argument is the global object
        ns = S.namespace('KISSY.app2.Test2');
        ns.name = 'foo2';
        if(S.app2.Test2.name !== 'foo2') test.fail();

        // via cloned global object
        S.cloneTo('TB');
        ns = TB.namespace('app3.Test3');
        ns.name = 'foo3';
        if(TB.app3.Test3.name !== 'foo3') test.fail();

        // empty arguments
        if(S.namespace() !== null) test.fail();

        // clear
        delete S.app;
        delete S.app2;
        window.TB = undefined;
    }

    function test_each(test) {
        var S = KISSY, ret = 0;

        S.each([1,2,3,4,5], function(num) {
            ret += num;
        });

        if(ret !== 15) test.fail();
    }

    function test_indexOf(test) {
        var S = KISSY, a, ret;

        ret = S.indexOf(6, [1, 2, 3, 4, 5]);
        if(ret !== -1) test.fail('S.indexOf(6, [1, 2, 3, 4, 5]) = ' + ret);

        ret = S.indexOf(a, [1, 2, 3, 4, undefined]);
        if(ret === -1) test.fail('S.indexOf(a, [1, 2, 3, 4, undefined]) = ' + ret);

        ret = S.indexOf(2, [1, 2, 3, 4, 5]);
        if(ret === -1) test.fail('S.indexOf(2, [1, 2, 3, 4, 5]) = ' + ret);

        ret = S.indexOf({}, [1, 2, {}, 4, 5]);
        if(ret !== -1) test.fail('S.indexOf({}, [1, 2, {}, 4, 5]) = ' + ret);
    }

    function test_trim(test) {
        var S = KISSY,
            str = '    lots of spaces before and after    ';

        if(S.trim(str) !== 'lots of spaces before and after') test.fail();
    }

    function test_log(test) {
        var S = KISSY;

        S.add('test-ks-mod', function() { });
        S.log(S, 'dir');

        S.cloneTo('TB');
        TB.add('test-tb-mod', function() { });
        TB.Config.debug = false;
        S.log(TB, 'dir');

        // clear
        //delete S.Env.mods['test-ks-mod'];
        //window.TB = undefined;
    }

</script>
</body>
</html>
