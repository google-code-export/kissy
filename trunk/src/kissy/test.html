<!doctype html>
<html>
<head>
<meta charset="gbk"/>
<title>Test</title>
<script>
    var doc = document,
        get = function(id) {
            return typeof id === 'string' ? doc.getElementById(id) : id;
        },
        now = function() {
            return new Date().getTime();
        },
        fix = function(val) {
          return val < 10 ? '0' + val : val;
        },
        timeStamp = function() {
            var d = new Date();
            return fix(d.getHours()) + ':' + fix(d.getMinutes()) + ':' + fix(d.getSeconds());
        },
        tests = [],
        log, hidepasses, times, wl,
        konsole = {
            init: function() {
                log = get('log');
                hidepasses = get('hidepasses').checked;
                times = get('times').value;
                wl = get('wl').value;
            },
            time: function (test) {
                test.startTime = now();
            },
            timeEnd: function (test) {
                test.tookTime = now() - test.startTime;
            },
            echo: function(msg, br) {
                if (br === undefined) br = '<br />';
                log.innerHTML += msg + br;
                log.scrollTop = log.scrollHeight;
            },
            log: function (test) {
                var status = test.status || 'passed',
                    msg;

                msg = '<span class="' + status + '">';
                msg += timeStamp() + '  ';
                msg += '[' + status.toUpperCase() + '] ';
                msg += test.name + ': ';
                msg += test.tookTime + 'ms ';
                if (test.extraMsg) msg += test.extraMsg;
                msg += '</span>';

                this.echo(msg);
            }
        };

    // Adds test case
    tests.add = function(name, fn) {
        tests.push({
            'name': name,
            'fn': function() {
                fn.call(this);
            },
            'fail': function(msg) {
                this.status = 'failed';
                this.extraMsg = msg || '';
            }
        });
        return tests;
    };

    // Resets tests
    tests.reset = function() {
      for(var i = 0, n = tests.length; i < n; i++) {
          tests[i].status = '';
          tests[i].extraMsg = '';
      }
    };

    // Starts tests
    function start() {
        konsole.init();
        tests.reset();

        var len = tests.length, test, i, j;
        times = times || 1;
        wl = wl || '';

        konsole.echo(timeStamp() + '  Start');
        for (i = 0; i < len; i++) {
            test = tests[i];
            if (wl && wl.indexOf(test.name) === -1) continue;
            if (hidepasses && !test.status) continue;

            j = times;
            konsole.time(test);
            while (j--) test.fn();
            konsole.timeEnd(test);
            konsole.log(test);
        }
        konsole.echo(timeStamp() + '  Done', '<hr />');
    }
</script>
<style type="text/css">
    body {
        margin: 0;
        padding: 15px;
        font-size: 12px;
        line-height: 20px;
        font-family: Verdana, Arial, sans-serif;
    }

    #konsole {
        border: 1px solid #999;
        background-color: #eee;
        padding: 10px;
        margin-top: 10px;
    }

    #log {
        color: #666;
        border: 1px solid #999;
        background-color: #fff;
        padding: 5px;
        height: 312px;
        overflow-x: auto;
        overflow-y: scroll;
        font: 14px / 16px "Courier New", Courier, monospace;
        white-space: pre-wrap;
    }

    .passed {
        color: darkgreen;
    }

    .failed {
        color: #900;
    }

    hr {
        border: 0;
        border-top: 1px dotted #ccc;
        margin: 3px 0;
        color: #fff;
    }

    button {
        padding: 2px 20px;
    }

    #settings {
        padding: 10px;
        line-height: 25px;
    }
</style>
</head>
<body>
<form onsubmit="return false" action="">
    <button type="button" onclick="start()">Start</button>
    <div id="konsole">
        <div id="log"></div>
    </div>
    <div id="settings">
        Settings:<br/>
        <input type="checkbox" id="hidepasses" name="hidepasses"/>
        <label for="hidepasses">Hide passes</label><br/>
        <input type="text" value="1" id="times" size="4"/>
        <label for="times">Iteration times for each test function</label><br/>
        <input type="text" value="" id="wl" size="12"/>
        <label for="wl">The whitelist of test names</label>
    </div>
</form>

<script>
    var firstRun = true;
    window.KISSY = {test: 'ks-test-prop'};

    function removeArrayItem(fn, arr) {
        var ret = [];
        for(var i = 0, len = arr.length; i < len; i++) {
            if(!fn(arr[i], i, arr)) ret.push(arr[i]);
        }
        return ret;
    }
</script>
<script src="kissy.js"></script>
<script>
    
    tests.add('test_preserve', function() {
        if(firstRun) { // only check in first Run
            if (!KISSY.test) this.fail();
            delete KISSY.test; // clear
            firstRun = false;
        }
    });

    tests.add('test_add', function() {
        KISSY.add('test-ks-mod', function(S) {
           S.TestMod = { prop: 1 };
        });

        if(!KISSY.TestMod.prop) this.fail();
        if(KISSY.Env.mods['test-ks-mod'].name !== 'test-ks-mod') this.fail();

        // clear
        delete KISSY.TestMod;
        delete KISSY.Env.mods['test-ks-mod'];
    });

    tests.add('test_mix', function() {
        var S = KISSY,
            o1 = { a: 1, b: 2 },
            o3 = { a: 1, b: 2 },
            o4 = { a: 1, b: 2 },
            o2 = { a: 'a', c: true };

        S.mix(o1, o2);
        S.mix(o3, o2, false);
        S.mix(o4, o2, true, ['c']);

        if(o1.a !== 'a') this.fail();
        if(o3.a !== 1) this.fail();
        if(o4.a !== 1) this.fail();
    });

    tests.add('test_merge', function() {
        var S = KISSY,
            a = {
                'bool' : false,
                'num'  : 0,
                'nul'  : null,
                'undef': undefined,
                'T'    : 'blabber'
            },
            b = {
                'bool' : 'oops',
                'num'  : 'oops',
                'nul'  : 'oops',
                'undef': 'oops',
                'T'    : 'oops'
            };

        var c = S.merge(a, b);

        if(c.bool !== 'oops') this.fail();
        if(c.num !== 'oops') this.fail();
        if(c.nul !== 'oops') this.fail();
        if(c.undef !== 'oops') this.fail();
        if(c.T !== 'oops') this.fail();
    });

    tests.add('test_extend', function() {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            }
        };

        function Chicken(name) {
            Chicken.superclass.constructor.call(this, name);
        }
        S.extend(Chicken, Bird);

        var chicken = new Chicken('Tom');

        if(chicken.getName() !== 'Tom') this.fail();
    });

    tests.add('test_augment', function() {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            },
            fly: function() {
            }
        };

        function Pig(name) {
            this.name = name;
        }
        S.augment(Pig, Bird);

        var pig = new Pig('Babi');

        if(!pig.fly) this.fail();
    });

    tests.add('test_weave', function() {
        var S = KISSY;

        function Bird(name) {
            this.name = name;
        }
        Bird.prototype = {
            getName: function() {
                return this.name;
            }
        };

        S.weave(function() {
            this.name = 'Hacked ' + this.name;
        }, 'before', Bird.prototype, 'getName');

        var bird = new Bird('Bird');
        if(bird.getName() !== 'Hacked Bird') this.fail(bird.getName());
    });

    tests.add('test_each', function() {
        var S = KISSY, ret = 0;

        S.each([1,2,3,4,5], function(num) {
            ret += num;
        });

        if(ret !== 15) this.fail();
    });

    tests.add('test_cloneTo', function() {
        var S = KISSY;
        S.cloneTo('TB');

        // check static members
        if(TB.mix !== S.mix) this.fail();
        if(TB.cloneTo !== S.cloneTo) this.fail();

        // check Env and Config
        if(!TB.Env.mods) this.fail();
        if(TB.Config.debug !== true) this.fail();

        // check independence
        TB.test = 2;
        if(S.test === 2) this.fail();
        TB.Config.debug = false;
        if(S.Config.debug !== true) this.fail();

        // test add modules
        TB.add('test-tb-mod', function() { });
        if(!TB.Env.mods['test-tb-mod']) this.fail();
        if(S.Env.mods['test-tb-mod']) this.fail();

        // clear
        window.TB = undefined;
    });

    tests.add('test_namespace', function() {
        var S = KISSY, ns;

        // normal
        ns = S.namespace('app.Test');
        ns.name = 'foo1';
        if(S.app.Test.name !== 'foo1') this.fail();

        // first part of argument is the global object
        ns = S.namespace('KISSY.app2.Test2');
        ns.name = 'foo2';
        if(S.app2.Test2.name !== 'foo2') this.fail();

        // via cloned global object
        S.cloneTo('TB');
        ns = TB.namespace('app3.Test3');
        ns.name = 'foo3';
        if(TB.app3.Test3.name !== 'foo3') this.fail();

        // empty arguments
        if(S.namespace() !== null) this.fail();

        // clear
        delete S.app;
        delete S.app2;
        window.TB = undefined;
    });

    tests.add('test_log', function() {
        var S = KISSY;

        S.add('test-ks-mod', function() { });
        S.log(S, 'dir');

        S.cloneTo('TB');
        TB.add('test-tb-mod', function() { });
        TB.Config.debug = false;
        S.log(TB, 'dir');

        // clear
        //delete S.Env.mods['test-ks-mod'];
        //window.TB = undefined;
    });

</script>
</body>
</html>
