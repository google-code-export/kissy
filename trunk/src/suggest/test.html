<!doctype html>
<html>
<head>
<meta charset="gbk" />
<title>Suggest Test</title>

<link rel="stylesheet" href="../../build/cssreset-grids/reset-grids-min.css" />
<script src="../../third-party/yui2/yahoo-dom-event/yahoo-dom-event.js"></script>
<script src="../../build/packages/ks-core.js"></script>

<script src="suggest.js"></script>

<style>
    #page { padding: 50px 50px 300px; width: 950px; margin: 0 auto; line-height: 18px; }
    h1, h2, h3 { margin: 1em 0 0.3em; }
    .section ol { margin: 5px 20px; }
    .section ol li { list-style: decimal inside; margin: 5px 0; }
    .search-input { width: 300px; height: 20px; padding: 3px 2px 2px 4px; }
    .search-submit { padding: 4px 10px; margin-left: 5px; }
    html { overflow-y: scroll; }
</style>
</head>
<body>
<div id="page">
    <h1>Suggest: </h1>
    <form name="search" method="get" action="http://search1.taobao.com/browse/search_auction.htm">
        <input type="hidden" value="" name="sort"/>
        <input type="hidden" value="D9_5_1" name="f"/>
        <input type="hidden" value="" name="promote"/>
        <input type="hidden" value="2" name="isnew"/>
        <input type="hidden" value="b" name="atype"/>
        <input type="hidden" value="all" name="commend"/>
        <input type="hidden" value="auction" name="search_type"/>
        <input type="hidden" value="initiative" name="user_action"/>
        <input type="hidden" value="s1-e" name="ssid"/>

        <input name="q" id="q" class="search-input" />

        <button type="submit" class="search-submit">Search</button>
    </form>

    <div class="section">
        <h2>Features:</h2>
        <ol>
            <li>提示补全基本功能</li>
            <li>完全跨域</li>
            <li>小巧精简，仅依赖yui-dom-event, 压缩后不超过15k</li>
            <li>支持所有A级浏览器</li>
            <li>cache功能</li>
            <li>支持键盘控制：上下选择及回车后直接提交，ESC键关闭</li>
            <li>支持鼠标控制：鼠标选择和点击提交功能</li>
            <li>支持JSON静态数据源</li>
            <li>[DELAY] 支持匹配文字加亮</li>
            <li>[DELAY] 动画效果</li>
            <li>[DELAY] 在提示层中显示第一个搜索结果</li>
            <li>[DELAY] 整合本地表单的提示记录</li>
            <li>[DELAY] 关键词的模糊匹配提示功能</li>
        </ol>
    </div>

    <div class="section">
        <h2>Test Cases:</h2>
        <ol>
            <li>基本功能：输入时有提示，键盘操作，鼠标操作，点击提交按钮可正常提交</li>
            <li>用Del或Backspace键将输入清空时，提示层隐藏</li>
            <li>当返回结果为空时，提示层隐藏</li>
            <li>点击提示层外面，能关闭提示层</li>
            <li>ESC键能关闭提示层。并且当有选中项时，能还原输入值</li>
            <li>鼠标悬浮在提示层，继续输入时，取消选中项</li>
            <li>服务器超慢的处理（抛弃旧请求，只显示最新结果）</li>
            <li>鼠标选中某项+点击 or 键盘选中某项+回车 时，会触发onItemSelect</li>
            <li>先用鼠标选中某项，然后从侧边绕过提示层移动到输入框，ENTER提交，不触发onItemSelect</li>
            <li>服务器超时和返回错误数据时的容错</li>
            <li>鼠标点击选中，提交表单时，能触发form的onsubmit事件</li>
            <li>ie6下，能覆盖select</li>
            <li>在主流输入法开启时测试</li>
            <li>在所有A级浏览器下测试</li>
            <li>持续按下DOWN/UP键时，选中操作正常（注意Opera下无效）</li>
            <li>在提示层任意处按下鼠标，保持按住状态，移动到提示层外释放鼠标，这时输入框应该保持focus状态</li>
            <li>在提示层A项处按下鼠标，移动到B处释放，不触发onItemSelect</li>
            <li>在提示层A项处按下鼠标，移动鼠标到其它地方，最后移动回A处释放，触发onItemSelect</li>
            <li>输入法开启，通过enter键输入英文时，不会触发提交</li>
            <li>选中某项，ESC键关闭，再次通过keydown打开时，能保持原来的选中项</li>
            <li>没有选中项，ESC键关闭，再次通过keydown打开时，依旧没有选中项</li>
            <li>当输入框为空时，按下 ESC 键，输入框失去焦点</li>
        </ol>
    </div>

    <div class="section">
        <h2>References:</h2>
        <ol>
            <li><a href="http://www.cnbeta.com/articles/84703.htm">Google搜索建议升级</a></li>
            <li><a href="http://developer.yahoo.com/yui/autocomplete/">YUI AutoComplete</a></li>
        </ol>
    </div>

    <div class="section">
        <h2>Crazy Test:</h2>

        <h3>1. dataRequest 和 dataReturn 事件：( 请输入 pig 和 dog )</h3>
        <form name="search2" method="get" action="http://search1.taobao.com/browse/search_auction.htm" target="_blank">
            <input class="search-input" name="q" id="q2"/>
            <button type="submit" class="search-submit">Search</button>
        </form>

        <h3>2. show 和 itemSelect 事件：</h3>
        <form name="search3" method="get" action="http://search1.taobao.com/browse/search_auction.htm">
            <input class="search-input" name="q" id="q3"/>
            <button type="submit" class="search-submit">Search</button>
        </form>

        <h3>3. 测试提示层宽度和遮罩：</h3>
        <form name="search4" method="get" action="http://search1.taobao.com/browse/search_auction.htm" target="_blank">
            <input name="q" id="q4" style="margin-left: 100px" />
            <button type="submit">Search</button>
        </form>
        <br>
        <select>
            <option>你能把我遮罩住吗，嘿嘿 你能把我遮罩住吗你能把我遮罩住吗</option>
        </select>
        <br>
        <br>
        <iframe src="../../"></iframe>

        <h3>4. 测试JSON数据源：（请输入 nike 或 nokia ）</h3>
        <form name="search4" method="get" action="http://search1.taobao.com/browse/search_auction.htm" target="_blank">
            <input class="search-input" name="q" id="q5"/>
            <button type="submit" class="search-submit">Search</button>
        </form>

        <h3>5. 输入框的提示：（请输入 nike 或 nokia）</h3>
        <input class="search-input" id="q6" />

        <h3>6. 有啊有啊哈哈哈：</h3>
        <form name="search7" method="get" action="http://youa.baidu.com/search/s" target="_blank">
            <input class="search-input" name="keyword" id="q7" />
            <button type="submit" class="search-submit">百度一下</button>
        </form>
    </div>

</div>

<script>

    KISSY.ready(function(S) {

        var dataUrl = 'http://suggest.taobao.com/sug';
        //var dataUrl = 'http://t-yubo/work/lab/suggest/sug.php';
        //var dataUrl = 'http://192.168.208.18:8090/sug';

        // 淘宝首页的情况
        var sug = new S.Suggest('#q', dataUrl,
        { autoFocus: true,
            resultFormat: '约%result%个宝贝'
        });

        // 测试事件
        var sug2 = new S.Suggest('#q2', dataUrl);
        sug2.on('dataRequest', function() {
            if (this.query === 'pig') {
                alert('你输入的是：' + this.query);
            }
        });
        sug2.on('dataReturn', function() {
            if (this.query === 'dog') {
                alert('返回的数据是：' + YAHOO.lang.dump(this.returnedData));
            }
        });

        // 测试事件2
        var sug3 = new S.Suggest('#q3', dataUrl);
        sug3.on('show', function() {
            var container = this.container,
                list = S.get('ol', container);

            list.insertBefore(
                    S.DOM.create('<li class="even"><span class="ks-suggest-key">含 "' + this.query +'" 的商品</span></li>'),
                    S.get('li', list)
                 );
            list.insertBefore(
                    S.DOM.create('<li class="odd"><span class="ks-suggest-key">含 "' + this.query +'" 的店铺</span></li>'),
                    S.get('li', list)                    
                 );

            container.appendChild(document.createTextNode('我是天下无敌的广告'));
        });
        sug3.on('itemSelect', function() {
            alert('你选中了：' + this.textInput.value);
        });

        // 测试配置参数
        new S.Suggest('#q4', dataUrl, {
            containerWidth: '200px',
            showCloseBtn: true
        });

        // 测试JSON数据源
        var jsonData = {};
        jsonData['nike'] = [
            ["nike 正品", "2170000"],
            ["nike 专柜 正品", "834000"],
            ["nike 短袖", "242000"],
            ["nike 板 鞋", "989000"],
            ["nike 女鞋", "253000"],
            ["nike 运动鞋", "550000"],
            ["nike 包", "295000"],
            ["nike 鞋", "3160000"],
            ["nike 单肩包", "38500"],
            ["nike 09", "786000"]
        ];
        jsonData['nokia'] = [
            ["nokia 手机", "17900"],
            ["nokia 5800", "3040"],
            ["nokia e71", "3520"],
            ["nokia 8800", "1850"],
            ["nokia n95", "5890"],
            ["nokia n97", "237"],
            ["nokia n78", "2200"],
            ["nokia n85", "2880"],
            ["nokia n81", "2620"],
            ["nokia e66", "1740"]
        ];
        new S.Suggest('#q5', jsonData);

        // 测试JSON数据源
        var jsonData2 = {};
        jsonData2['nike'] = [
            "nike 正品",
            "nike 专柜 正品",
            "nike 短袖",
            "nike 板 鞋",
            "nike 女鞋",
            "nike 运动鞋",
            "nike 包",
            "nike 鞋",
            "nike 单肩包",
            "nike 09"
        ];
        jsonData2['nokia'] = [
            "nokia 手机",
            "nokia 5800",
            "nokia e71",
            "nokia 8800",
            "nokia n95",
            "nokia n97",
            "nokia n78",
            "nokia n85",
            "nokia n81",
            "nokia e66"
        ];
        new S.Suggest('#q6', jsonData2);

        // 有啊有啊哈哈哈
        dataUrl = 'http://youa.baidu.com/suggest/se/s';
        window["suggestCallback"] = window["g_ks_suggest_callback"];
        // http://youa.baidu.com/suggest/se/s?cmd=suggest&type=kwd&max_count=10&callback=suggestCallback&keyword=n
        var sug7 = new S.Suggest('#q7', dataUrl);
        sug7.on('dataRequest', function() {
            this.dataScript.charset = 'GBK';
            this.queryParams = 'cmd=suggest&type=kwd&max_count=10&keyword=' + encodeURIComponent(this.query) + '&callback=suggestCallback';
        });
        // youa: suggestCallback({"err":"ok", "r":[{"key":"nike", "val":140000}, {"key":"nike鞋", "val":119000}, {"key":"nike板鞋", "val":44300}, {"key":"nike运动鞋", "val":115000}, {"key":"nike正品", "val":47400}, {"key":"nike包", "val":8300}, {"key":"nike篮球鞋", "val":18400}, {"key":"nike新款", "val":27600}, {"key":"nike 耐克", "val":140000}, {"key":"nike女鞋", "val":7850}], "num":10})
        // taobao: g_ks_suggest_callback({"result": [["nike 正品", "2170000"], ["nike 专柜 正品", "834000"], ["nike 短袖", "242000"], ["nike 板 鞋", "989000"], ["nike 女鞋", "253000"], ["nike 运动鞋", "550000"], ["nike 包", "295000"], ["nike 鞋", "3160000"], ["nike 单肩包", "38500"], ["nike 09", "786000"]]})
        sug7.on('dataReturn', function() {
            var data = this.returnedData['r'] || [];
            var result = [];

            for (var i = 0, len = data.length; i < len; ++i) {
                result.push([data[i]['key'], data[i]['val']]);
            }

            this.returnedData = result;
        });
    });
</script>
</body>
</html>
